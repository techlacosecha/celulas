<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Células de Crecimiento | Zona</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- DataTables v2 – CSS -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.2/css/dataTables.dataTables.min.css"/>

  <style>
    /* ---------- page chrome ---------- */
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fafafa}

    /* banner */
    header.banner{width:100vw;overflow:hidden}
    header.banner img{width:100%;height:auto;display:block}

    /* controls */
    .controls{margin:1.5rem 2rem;max-width:100vw;white-space:nowrap}
    #zonaSelect{margin-left:.5rem;padding:.35rem .6rem;font-size:1rem}

    /* ---------- desktop table ---------- */
    .table-wrapper{overflow-x:auto;padding:0 2rem 2rem 2rem}
    table.dataTable{
      border:2px solid #13284b;border-collapse:collapse;width:100%;table-layout:auto
    }
    table.dataTable th,table.dataTable td{word-break:break-word;white-space:normal}
    table.dataTable thead th{
      background:#2d57a3;color:#fff;border:1px solid #13284b;font-weight:700;text-align:center
    }
    table.dataTable tbody td:nth-child(1){
      background:#eeeeee;font-weight:700;text-align:center
    }
    table.dataTable tbody tr:nth-child(even) td{background:#f8f8f8}
    table.dataTable tbody td{
      border:1px solid #cccccc;vertical-align:top;padding:6px 4px
    }

    /* ---------- mobile card view ---------- */
    .cards{display:none;padding:0 1rem 2rem}
    .card{
      border:1px solid #cccccc;border-radius:6px;margin-bottom:1rem;padding:1rem;background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,.06)
    }
    .card h2{margin:0 0 .5rem;font-size:1.15rem}
    .card p{margin:.25rem 0;font-size:.95rem;line-height:1.25}
    .card .dir{margin-top:.5rem}

    /* ---------- switch at ≤ 900 px ---------- */
    @media (max-width:900px){
      .table-wrapper{display:none}
      .cards{display:block}
      .controls{margin:1rem 1rem}
    }

    #error{color:#c00;margin:1rem 2rem 0;font-weight:bold}
  </style>
</head>
<body>
  <!-- banner -->
  <header class="banner">
    <img src="./header.png"
         alt="La Cosecha Community Church – Células de Crecimiento por Zona">
  </header>

  <!-- filter -->
  <div class="controls">
    <label for="zonaSelect"><strong>Zona:</strong></label>
    <select id="zonaSelect"><option value="">— Todas —</option></select>
  </div>

  <!-- desktop table -->
  <div class="table-wrapper">
    <table id="tabla" class="display"></table>
  </div>

  <!-- mobile cards -->
  <div id="cards" class="cards"></div>

  <div id="error" hidden></div>

  <!-- libraries -->
  <script src="./xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.2/js/dataTables.min.js"></script>

  <!-- logic -->
  <script>
  (async () => {
    const workbookPath = 'celulas.xlsx';
    const sheetName    = 'Consolidado';

    try {
      /* fetch + parse */
      const buf = await fetch(workbookPath).then(r=>{
        if(!r.ok) throw new Error('No se encontró '+workbookPath);
        return r.arrayBuffer();
      });
      const wb  = XLSX.read(buf,{type:'array'});
      const sheet = wb.Sheets[sheetName] ?? wb.Sheets[wb.SheetNames[0]];
      if(!sheet) throw new Error('Hoja "'+sheetName+'" no encontrada');

      const rowsArr = XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
      const header  = rowsArr[0].map(h=>String(h).trim());
      const dataRaw = rowsArr.slice(1).filter(r=>r.some(x=>x!==''));
      const rows = dataRaw.map(r=>{
        const o={}; header.forEach((h,i)=>o[h]=r[i]); return o;
      });

      /* dropdown */
      const zonaIdx = header.findIndex(h=>h.toUpperCase()==='ZONA');
      const zonas   = [...new Set(rows.map(r=>r[header[zonaIdx]]).filter(Boolean))].sort();
      const sel=document.getElementById('zonaSelect');
      zonas.forEach(z=>sel.add(new Option(z,z)));

      /* desktop DataTable */
      const table = new DataTable('#tabla',{
        data:rows,
        columns:header.map(h=>({title:h,data:h})),
        paging:true,searching:false,info:true,autoWidth:true,
        language:{
          info:'Mostrando _START_-_END_ de _TOTAL_ registros',
          infoEmpty:'Sin registros',
          paginate:{previous:'‹', next:'›'}
        }
      });
      table.columns.adjust();

      /* mobile card builder */
      const cardsDiv = document.getElementById('cards');
      function buildCards(dataset){
        cardsDiv.innerHTML = dataset.map(obj=>`
          <div class="card">
            <h2>#${obj['#'] ?? ''} – ${obj[header[zonaIdx]]}</h2>
            <p><strong>Maestro:</strong> ${obj['MAESTRO']||''}</p>
            <p><strong>Asistente:</strong> ${obj['ASISTENTE']||''}</p>
            <p class="dir"><strong>Dirección:</strong><br>${String(obj['DIRECCION']||'').replace(/\n/g,'<br>')}</p>
            <p><strong>Día / Hora:</strong> ${obj['DIA']||''} ${obj['HORA']||''}</p>
            <p><strong>Idioma:</strong> ${obj['IDIOMA']||''}</p>
            <p><strong>Teléfono:</strong> ${obj['TELEFONO']||''}</p>
          </div>
        `).join('');
      }
      buildCards(rows);

      /* sync filter to both views */
      sel.addEventListener('change',e=>{
        const v=e.target.value;
        const filtered=v?rows.filter(r=>r[header[zonaIdx]]===v):rows;
        table.clear().rows.add(filtered).draw();
        buildCards(filtered);
      });

    } catch(err){
      console.error(err);
      const d=document.getElementById('error');
      d.textContent='⚠️ '+err.message;
      d.hidden=false;
    }
  })();
  </script>
</body>
</html>
