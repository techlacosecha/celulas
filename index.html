<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Células de Crecimiento | Zona</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- DataTables v2 CSS (vanilla theme) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.2/css/dataTables.dataTables.min.css"/>

  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fafafa}
    header img{width:100%;max-height:25vh;object-fit:cover}
    .controls{margin:1rem 2rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
    #zonaSelect, #homeInput{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px}
    #homeInput{min-width:260px;flex:1 1 260px}
    #homeInput::placeholder{color:#999}
    #searchBtn{padding:.35rem .9rem;font-size:1rem;border:1px solid #2d57a3;
               background:#2d57a3;color:#fff;border-radius:4px;cursor:pointer}
    #searchBtn:disabled{opacity:.5;cursor:not-allowed}

    .table-wrapper{height:65vh;overflow:auto;padding:0 2rem 1.5rem}
    table.dataTable{border:2px solid #13284b;border-collapse:collapse;width:100%;table-layout:fixed}
    table.dataTable th{background:#2d57a3;color:#fff;border:1px solid #13284b;font-weight:700;text-align:center}
    table.dataTable td{border:1px solid #ccc;padding:6px 4px;word-wrap:break-word}
    table.dataTable tbody td:nth-child(1){background:#eee;font-weight:700;text-align:center}
    table.dataTable tbody tr:nth-child(even) td{background:#f8f8f8}

    .cards{display:none;padding:0 1rem 2rem;overflow:auto;height:65vh}
    .card{border:1px solid #ccc;border-radius:6px;margin-bottom:1rem;padding:1rem;background:#fff;
          box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .card h2{margin:.2rem 0 .6rem;font-size:1.15rem}
    .card p{margin:.25rem 0;font-size:.95rem}

    @media(max-width:900px){
      .table-wrapper{display:none}
      .cards{display:block}
      .controls{margin:1rem}
    }

    #nearest{margin:.5rem 2rem 0;font-weight:600}
    #error{color:#c00;margin:1rem 2rem 0;font-weight:700}
  </style>
</head>
<body>
  <header>
    <img src="./header.png" alt="La Cosecha – Células">
  </header>

  <div class="controls">
    <label for="zonaSelect"><strong>Zona:</strong></label>
    <select id="zonaSelect"><option value="">— Todas —</option></select>

    <label for="homeInput" class="addr-label">Find nearest address:</label>
    <input id="homeInput" type="text" placeholder="Home Address" autocomplete="off"/>
    <button id="searchBtn">Search</button>
  </div>

  <div id="nearest"></div>

  <div class="table-wrapper">
    <table id="tabla" class="display"></table>
  </div>
  <div id="cards" class="cards"></div>
  <div id="error" hidden></div>

  <!-- 1) SheetJS (local copy) -->
  <script src="./xlsx.full.min.js"></script>

  <!-- 2) DataTables v2 vanilla bundle (defines global DataTable) -->
  <script defer
    src="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.2/js/dataTables.dataTables.min.js">
  </script>

  <!-- 3) Google Maps JS via js-api-loader (Places) -->
  <script type="module">
    import { Loader } from 'https://cdn.jsdelivr.net/npm/@googlemaps/js-api-loader@2.16.0/dist/index.esm.js';

    // State & caches
    let rows = [], table, cardsDiv, geocoder, distSvc, homePos = null;
    const geoCache = new Map();

    // Helpers
    const renderCards = list => {
      cardsDiv.innerHTML = list.map(o => `
        <div class="card">
          <h2>#${o['#']} – ${o['ZONA']}</h2>
          <p><strong>Dirección:</strong> ${o['DIRECCION']}</p>
          <p><strong>Día / Hora:</strong> ${o['DIA']} ${o['HORA']}</p>
        </div>
      `).join('');
    };

    const gc = addr => {
      if (geoCache.has(addr)) return geoCache.get(addr);
      return new Promise(res => geocoder.geocode({ address: addr }, (r, st) => {
        const loc = st === 'OK'
          ? { lat: r[0].geometry.location.lat(), lng: r[0].geometry.location.lng() }
          : null;
        geoCache.set(addr, loc);
        res(loc);
      }));
    };

    const dm = (o, d) => {
      return new Promise(res => distSvc.getDistanceMatrix({
        origins: [new google.maps.LatLng(o.lat, o.lng)],
        destinations: [new google.maps.LatLng(d.lat, d.lng)],
        travelMode: 'DRIVING',
        drivingOptions: { departureTime: new Date(), trafficModel: 'best_guess' }
      }, (m, st) => {
        const e = m?.rows[0].elements[0];
        res(st === 'OK' && e.status === 'OK'
          ? (e.duration_in_traffic || e.duration).value
          : null
        );
      }));
    };

    async function runSearch() {
      const raw = document.getElementById('homeInput').value.trim();
      if (!raw) return;
      const btn = document.getElementById('searchBtn'),
            out = document.getElementById('nearest');
      btn.disabled = true;
      out.textContent = 'Buscando...';

      try {
        if (!homePos) homePos = await gc(raw);
        if (!homePos) throw new Error('No se pudo geocodificar tu dirección');

        let best = null, min = Infinity;
        for (const r of rows) {
          let a = r['DIRECCION'] || '';
          const dash = a.indexOf('-');
          if (dash !== -1) a = a.slice(dash + 1).trim();
          const dest = await gc(a);
          if (!dest) continue;
          const sec = await dm(homePos, dest);
          if (sec !== null && sec < min) { min = sec; best = r; }
        }
        if (!best) throw new Error('No se encontró destino');

        document.getElementById('nearest').textContent =
          `≈ ${Math.round(min/60)} min de manejo hasta la célula más cercana (#${best['#']} – ${best['ZONA']})`;

        table.clear().rows.add([best]).draw();
        renderCards([best]);

      } catch (e) {
        document.getElementById('nearest').textContent = 'Error: ' + e.message;
      }
      btn.disabled = false;
    }

    // 0️⃣ Build the table and cards ASAP
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const wb = XLSX.read(await fetch('celulas.xlsx').then(r => r.arrayBuffer()), { type:'array' });
        const sh = wb.Sheets['Consolidado'] ?? wb.Sheets[wb.SheetNames[0]];
        const arr = XLSX.utils.sheet_to_json(sh, { header:1, defval:'' });
        const head = arr[0].map(h => String(h).trim());

        rows = arr.slice(1)
                  .filter(r => r.some(x=>x!==''))
                  .map(r => { const o={}; head.forEach((h,i)=>o[h]=r[i]); return o; });

        const zonaIdx = head.findIndex(h=>h.toUpperCase()==='ZONA'),
              numIdx  = head.findIndex(h=>h.trim()==='#');

        // Initialize DataTable (global DataTable from the vanilla bundle)
        table = new DataTable('#tabla', {
          data: rows,
          columns: head.map(h=>({title:h,data:h})),
          order: [[numIdx,'asc'],[zonaIdx,'asc']],
          pageLength: 10
        });

        cardsDiv = document.getElementById('cards');
        renderCards(rows);

        document.getElementById('zonaSelect').addEventListener('change', e => {
          document.getElementById('nearest').textContent = '';
          const v = e.target.value;
          const f = v ? rows.filter(r=>r['ZONA']===v) : rows;
          table.clear().rows.add(f).draw();
          renderCards(f);
          homePos = null;
        });
      } catch (err) {
        document.getElementById('error').hidden = false;
        document.getElementById('error').textContent = err;
      }
    });

    // 1️⃣ Load Maps JS & wire up autocomplete + search
    const loader = new Loader({
      apiKey: 'AIzaSyC4LU0O02a7lCRtZeyGbigQQcJ4EuSKa7A',
      libraries: ['places']
    });
    loader.load()
      .then(() => {
        geocoder = new google.maps.Geocoder();
        distSvc  = new google.maps.DistanceMatrixService();

        const acEl = new google.maps.places.PlaceAutocompleteElement({
          element: document.getElementById('homeInput'),
          fields: ['geometry']
        });
        acEl.addListener('place_changed', () => {
          const p = acEl.getPlace();
          homePos = p.geometry
            ? { lat: p.geometry.location.lat(), lng: p.geometry.location.lng() }
            : null;
        });

        document.getElementById('searchBtn')
                .addEventListener('click', runSearch);
      })
      .catch(err => {
        console.error('Maps failed to load:', err);
        document.getElementById('error').hidden = false;
        document.getElementById('error').textContent = 'Error cargando Maps API';
      });
  </script>
</body>
</html>
