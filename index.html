<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Células de Crecimiento | Zona</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<!-- DataTables v2 CSS (vanilla “DT” theme) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.2/css/dataTables.dataTables.min.css"/>

<style>
/* ——— layout / look ——— */
body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fafafa}
header img{width:100%;max-height:25vh;object-fit:cover}
.controls{margin:1rem 2rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
#zonaSelect{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px}
.addr-label{font-weight:600}
#homeInput{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px;min-width:260px;flex:1 1 260px}
#homeInput::placeholder{color:#999}
#searchBtn{padding:.35rem .9rem;font-size:1rem;border:1px solid #2d57a3;background:#2d57a3;color:#fff;border-radius:4px;cursor:pointer}
#searchBtn:disabled{opacity:.5;cursor:not-allowed}

.table-wrapper{height:65vh;overflow:auto;padding:0 2rem 1.5rem}
table.dataTable{border:2px solid #13284b;border-collapse:collapse;width:100%;table-layout:fixed}
table.dataTable thead th{background:#2d57a3;color:#fff;border:1px solid #13284b;font-weight:700;text-align:center}
table.dataTable tbody td:nth-child(1){background:#eee;font-weight:700;text-align:center}
table.dataTable tbody tr:nth-child(even) td{background:#f8f8f8}
table.dataTable td{border:1px solid #ccc;padding:6px 4px;word-wrap:break-word}

.cards{display:none;padding:0 1rem 2rem;overflow:auto;height:65vh}
.card{border:1px solid #ccc;border-radius:6px;margin-bottom:1rem;padding:1rem;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.card h2{margin:.2rem 0 .6rem;font-size:1.15rem}
.card p{margin:.25rem 0;font-size:.95rem}

@media(max-width:900px){.table-wrapper{display:none}.cards{display:block}.controls{margin:1rem}}

#nearest{margin:.5rem 2rem 0;font-weight:600}
#error{color:#c00;margin:1rem 2rem 0;font-weight:700}
</style>
</head>
<body>
<header><img src="./header.png" alt="Células La Cosecha"></header>

<div class="controls">
  <label for="zonaSelect"><strong>Zona:</strong></label>
  <select id="zonaSelect"><option value="">— Todas —</option></select>
  <label for="homeInput" class="addr-label">Find nearest address:</label>
  <input id="homeInput" type="text" placeholder="Home Address">
  <button id="searchBtn">Search</button>
</div>

<div id="nearest"></div>

<div class="table-wrapper"><table id="tabla" class="display"></table></div>
<div id="cards" class="cards"></div>
<div id="error" hidden></div>

<!-- SheetJS (local copy) -->
<script src="./xlsx.full.min.js"></script>

<!-- 1) DataTables core – defines global window.DataTable -->
<script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.2/js/dataTables.min.js"></script>
<!-- 2) “DT” styling plug-in (adds the vanilla theme) -->
<script src="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.2/js/dataTables.dataTables.min.js"></script>

<!-- Google Maps JS (with Places) -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4LU0O02a7lCRtZeyGbigQQcJ4EuSKa7A&libraries=places&callback=gmapsReady"></script>

<script>
/* ---------- state ---------- */
let rows=[],table,cardsDiv,geo,dist,homePos=null;
const geoCache=new Map();

/* ---------- build table/cards ---------- */
(async()=>{
  const wb=XLSX.read(await fetch('celulas.xlsx').then(r=>r.arrayBuffer()),{type:'array'});
  const sh=wb.Sheets['Consolidado']??wb.Sheets[wb.SheetNames[0]];
  const arr=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
  const head=arr[0].map(h=>String(h).trim());
  rows=arr.slice(1).filter(r=>r.some(x=>x!=='')).map(r=>{const o={};head.forEach((h,i)=>o[h]=r[i]);return o});
  const zonaIdx=head.findIndex(h=>h.toUpperCase()==='ZONA'), numIdx=head.findIndex(h=>h.trim()==='#');

  const sel=zonaSelect; [...new Set(rows.map(r=>r['ZONA']).filter(Boolean))].sort()
    .forEach(z=>sel.add(new Option(z,z)));

  table=new DataTable('#tabla',{data:rows,columns:head.map(h=>({title:h,data:h})),
    order:[[numIdx,'asc'],[zonaIdx,'asc']],pageLength:10});
  cardsDiv=document.getElementById('cards'); renderCards(rows);

  sel.addEventListener('change',()=>{nearest.textContent='';
    const v=sel.value,f=v?rows.filter(r=>r['ZONA']===v):rows;
    table.clear().rows.add(f).draw();renderCards(f);homePos=null;});
})().catch(e=>{error.hidden=false;error.textContent=e;});

function renderCards(list){cardsDiv.innerHTML=list.map(o=>`
  <div class="card"><h2>#${o['#']} – ${o['ZONA']}</h2>
    <p><strong>Dirección:</strong> ${o['DIRECCION']}</p>
    <p><strong>Día / Hora:</strong> ${o['DIA']} ${o['HORA']}</p></div>`).join('');}

/* ---------- Google Maps ready ---------- */
function gmapsReady(){
  geo=new google.maps.Geocoder();
  dist=new google.maps.DistanceMatrixService();
  new google.maps.places.Autocomplete(homeInput,{types:['geocode']})
    .addListener('place_changed',function(){const p=this.getPlace();
      homePos=p.geometry?{lat:p.geometry.location.lat(),lng:p.geometry.location.lng()}:null;});
  searchBtn.addEventListener('click',runSearch);
}

/* ---------- helpers ---------- */
const gc=addr=>{if(geoCache.has(addr))return geoCache.get(addr);
  return new Promise(r=>geo.geocode({address:addr},(re,s)=>{const loc=s==='OK'?{lat:re[0].geometry.location.lat(),lng:re[0].geometry.location.lng()}:null;
    geoCache.set(addr,loc);r(loc);}));};
const dm=(o,d)=>new Promise(r=>dist.getDistanceMatrix({
  origins:[new google.maps.LatLng(o.lat,o.lng)],
  destinations:[new google.maps.LatLng(d.lat,d.lng)],
  travelMode:'DRIVING',
  drivingOptions:{departureTime:new Date(),trafficModel:'best_guess'}
},(m,s)=>{const el=m&&m.rows[0].elements[0];r(s==='OK'&&el.status==='OK'?(el.duration_in_traffic||el.duration).value:null);}));;

/* ---------- search ---------- */
async function runSearch(){
  const addr=homeInput.value.trim(); if(!addr)return;
  searchBtn.disabled=true; nearest.textContent='Buscando...';
  try{
    if(!homePos)homePos=await gc(addr); if(!homePos)throw Error('No se pudo geocodificar');
    let best=null,min=1e12;
    for(const r of rows){
      let a=r['DIRECCION']||''; const cut=a.indexOf('-'); if(cut!==-1)a=a.slice(cut+1).trim();
      const dest=await gc(a); if(!dest)continue;
      const sec=await dm(homePos,dest); if(sec!=null&&sec<min){min=sec;best=r;}
    }
    if(!best)throw Error('No se encontró destino');
    nearest.textContent=`≈ ${Math.round(min/60)} min de manejo hasta la célula más cercana (#${best['#']} – ${best['ZONA']})`;
    table.clear().rows.add([best]).draw(); renderCards([best]);
  }catch(e){nearest.textContent='Error: '+e.message;}
  searchBtn.disabled=false;
}
</script>
</body>
</html>
