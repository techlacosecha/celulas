<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Células de Crecimiento | Zona</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.2/css/dataTables.dataTables.min.css"/>
<style>
body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fafafa;overflow:hidden}
header.banner img{width:100%;max-height:25vh;object-fit:cover;display:block}
.controls{margin:1rem 2rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
#zonaSelect,#homeInput{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px;width:240px;max-width:100%}
#homeInput::placeholder{color:#999}
#searchBtn{padding:.35rem .9rem;font-size:1rem;border:1px solid #2d57a3;background:#2d57a3;color:#fff;border-radius:4px;cursor:pointer}
#searchBtn:disabled{opacity:.5;cursor:not-allowed}
.table-wrapper{height:calc(75vh - 3rem);overflow:auto;padding:0 2rem 1rem}
table.dataTable{border:2px solid #13284b;border-collapse:collapse;width:100%;table-layout:fixed}
table.dataTable th,table.dataTable td{word-wrap:break-word;white-space:normal}
table.dataTable thead th{background:#2d57a3;color:#fff;border:1px solid #13284b;font-weight:700;text-align:center}
table.dataTable tbody td:nth-child(1){background:#eeeeee;font-weight:700;text-align:center}
table.dataTable tbody tr:nth-child(even) td{background:#f8f8f8}
table.dataTable tbody td{border:1px solid #cccccc;vertical-align:top;padding:6px 4px}
.cards{display:none;padding:0 1rem 2rem;overflow:auto;height:calc(75vh - 3rem)}
.card{border:1px solid #ccc;border-radius:6px;margin-bottom:1rem;padding:1rem;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.card.highlight{border:2px solid #2d57a3}
.card h2{margin:0 0 .5rem;font-size:1.15rem}.card p{margin:.25rem 0;font-size:.95rem;line-height:1.25}
@media(max-width:900px){body{overflow:auto}.table-wrapper{display:none}.cards{display:block}.controls{margin:1rem}}
#nearest{margin:.5rem 2rem 0;font-weight:600}
#error{color:#c00;margin:1rem 2rem 0;font-weight:700}
</style>
</head>
<body>
<header class="banner"><img src="./header.png" alt="La Cosecha Community Church – Células de Crecimiento por Zona"></header>

<div class="controls">
  <label><strong>Zona:</strong>
    <select id="zonaSelect"><option value="">— Todas —</option></select>
  </label>
  <label style="display:flex;align-items:center;gap:.4rem">
    <span style="font-weight:600">Find nearest address:</span>
    <input id="homeInput" type="text" placeholder="Home Address">
  </label>
  <button id="searchBtn">Search</button>
</div>

<div id="nearest"></div>

<div class="table-wrapper"><table id="tabla" class="display"></table></div>
<div id="cards" class="cards"></div>
<div id="error" hidden></div>

<!-- Google Maps JS with Places library -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY_HERE&libraries=places"></script>

<script src="./xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.2/js/dataTables.min.js"></script>

<script>
const API_KEY='AIzaSyC4LU0O02a7lCRtZeyGbigQQcJ4EuSKa7A';          // <--- PUT YOUR KEY HERE
const geoCache=new Map();                          // address -> {lat,lng}

(async () => {
  /* ---------- utility functions ---------- */
  async function geocode(addr){
    if(geoCache.has(addr)) return geoCache.get(addr);
    const url=`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(addr)}&key=${API_KEY}`;
    const js=await fetch(url).then(r=>r.json());
    if(js.status!=='OK'){geoCache.set(addr,null); return null;}
    const loc=js.results[0].geometry.location;
    geoCache.set(addr,loc); return loc;
  }
  async function durationSec(orig,dest){
    const url=`https://maps.googleapis.com/maps/api/distancematrix/json?origins=${orig.lat},${orig.lng}&destinations=${dest.lat},${dest.lng}&mode=driving&key=${API_KEY}`;
    const js=await fetch(url).then(r=>r.json());
    if(js.status!=='OK'||js.rows[0].elements[0].status!=='OK')return null;
    return js.rows[0].elements[0].duration.value;
  }
  /* -------------------------------------- */

  /* ---------- Excel load ---------- */
  const workbookPath='celulas.xlsx', sheetName='Consolidado';
  const buf=await fetch(workbookPath).then(r=>{if(!r.ok)throw new Error('No '+workbookPath);return r.arrayBuffer()});
  const wb=XLSX.read(buf,{type:'array'}), sheet=wb.Sheets[sheetName]??wb.Sheets[wb.SheetNames[0]];
  const rowsArr=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
  const header=rowsArr[0].map(h=>String(h).trim());
  const rows=rowsArr.slice(1).filter(r=>r.some(x=>x!=='')).map(r=>{const o={};header.forEach((h,i)=>o[h]=r[i]);return o});
  const zonaIdx=header.findIndex(h=>h.toUpperCase()==='ZONA'), numIdx=header.findIndex(h=>h.trim()==='#');

  /* ---------- dropdown + table ---------- */
  const sel=document.getElementById('zonaSelect');
  [...new Set(rows.map(r=>r['ZONA']).filter(Boolean))].sort().forEach(z=>sel.add(new Option(z,z)));
  const table=new DataTable('#tabla',{data:rows,columns:header.map(h=>({title:h,data:h})),order:[[numIdx,'asc'],[zonaIdx,'asc']],
    pageLength:10,scrollY:'100%',scrollCollapse:true,autoWidth:false,language:{paginate:{previous:'‹',next:'›'}}}); table.columns.adjust();
  const cardsDiv=document.getElementById('cards');
  function renderCards(set,hi){cardsDiv.innerHTML=set.map(o=>{const k=`${o['#']}‖${o['ZONA']}`;return`
    <div class="card ${k===hi?'highlight':''}"><h2>#${o['#']} – ${o['ZONA']}</h2>
    <p><strong>Maestro:</strong> ${o['MAESTRO']}</p><p><strong>Asistente:</strong> ${o['ASISTENTE']}</p>
    <p><strong>Dirección:</strong><br>${String(o['DIRECCION']).replace(/\n/g,'<br>')}</p>
    <p><strong>Día / Hora:</strong> ${o['DIA']} ${o['HORA']}</p><p><strong>Idioma:</strong> ${o['IDIOMA']}</p>
    <p><strong>Teléfono:</strong> ${o['TELEFONO']}</p></div>`}).join('');}
  renderCards(rows);
  sel.addEventListener('change',()=>{const v=sel.value,f=v?rows.filter(r=>r['ZONA']===v):rows;table.clear().rows.add(f).draw();table.columns.adjust();renderCards(f);document.getElementById('nearest').textContent='';});

  /* ---------- Places Autocomplete ---------- */
  const homeInput=document.getElementById('homeInput'), btn=document.getElementById('searchBtn'), nDiv=document.getElementById('nearest');
  let homePos=null;
  const ac=new google.maps.places.Autocomplete(homeInput,{types:['geocode']});
  ac.addListener('place_changed',()=>{const p=ac.getPlace();homePos=p.geometry?{lat:p.geometry.location.lat(),lng:p.geometry.location.lng()}:null;});
  /* Fallback geocode if user types free text and presses Search */

  btn.addEventListener('click',async()=>{
    const addr=homeInput.value.trim(); if(!addr)return;
    btn.disabled=true;nDiv.textContent='Buscando...';
    try{
      if(!homePos) homePos=await geocode(addr); if(!homePos) throw new Error('No se pudo geocodificar tu dirección');
      let best=null,minSec=1e12;
      for(const row of rows){
        let dir=row['DIRECCION']||''; const dash=dir.indexOf('-'); if(dash!==-1) dir=dir.slice(dash+1).trim();
        const dest=await geocode(dir); if(!dest) continue;
        const sec=await durationSec(homePos,dest); if(sec==null) continue;
        if(sec<minSec){minSec=sec;best=row;}
      }
      if(!best) throw new Error('No se pudo calcular la distancia');
      const min=Math.round(minSec/60);
      nDiv.textContent=`≈ ${min} min (Google) a la célula más cercana (#${best['#']} – ${best['ZONA']})`;
      const key=`${best['#']}‖${best['ZONA']}`; renderCards(sel.value?rows.filter(r=>r['ZONA']===sel.value):rows,key);
      table.rows().every(function(){const d=this.data();$(this.node()).toggleClass('highlight',d['#']==best['#']&&d['ZONA']==best['ZONA']);});
    }catch(e){nDiv.textContent='Error: '+e.message;}
    btn.disabled=false;
  });

})().catch(err=>{console.error(err);document.getElementById('error').textContent='⚠️ '+err.message;document.getElementById('error').hidden=false});
</script>
</body>
</html>
