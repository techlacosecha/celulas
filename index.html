<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Células de Crecimiento | Zona</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.2/css/dataTables.dataTables.min.css"/>
<style>
body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fafafa;overflow:hidden}
header.banner img{width:100%;max-height:25vh;object-fit:cover;display:block}

.controls{margin:1rem 2rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
#zonaSelect{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px}
.addr-label{white-space:nowrap;font-weight:600}
#homeInput{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px;min-width:260px;flex:1 1 260px;max-width:100%}
#homeInput::placeholder{color:#999}
#searchBtn{padding:.35rem .9rem;font-size:1rem;border:1px solid #2d57a3;background:#2d57a3;color:#fff;border-radius:4px;cursor:pointer}
#searchBtn:disabled{opacity:.5;cursor:not-allowed}

.table-wrapper{height:calc(75vh - 3rem);overflow:auto;padding:0 2rem 1rem}
table.dataTable{border:2px solid #13284b;border-collapse:collapse;width:100%;table-layout:fixed}
table.dataTable th,table.dataTable td{word-wrap:break-word;white-space:normal}
table.dataTable thead th{background:#2d57a3;color:#fff;border:1px solid #13284b;font-weight:700;text-align:center}
table.dataTable tbody td:nth-child(1){background:#eeeeee;font-weight:700;text-align:center}
table.dataTable tbody tr:nth-child(even) td{background:#f8f8f8}
table.dataTable tbody td{border:1px solid #cccccc;vertical-align:top;padding:6px 4px}

.cards{display:none;padding:0 1rem 2rem;overflow:auto;height:calc(75vh - 3rem)}
.card{border:1px solid #ccc;border-radius:6px;margin-bottom:1rem;padding:1rem;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.card h2{margin:0 0 .5rem;font-size:1.15rem}
.card p{margin:.25rem 0;font-size:.95rem;line-height:1.25}

@media(max-width:900px){
  body{overflow:auto}
  .table-wrapper{display:none}
  .cards{display:block}
  .controls{margin:1rem}
}

#nearest{margin:.5rem 2rem 0;font-weight:600}
#error{color:#c00;margin:1rem 2rem 0;font-weight:700}
</style>
</head>
<body>
<header class="banner"><img src="./header.png" alt="La Cosecha Community Church – Células de Crecimiento por Zona"></header>

<div class="controls">
  <label for="zonaSelect"><strong>Zona:</strong></label>
  <select id="zonaSelect"><option value="">— Todas —</option></select>

  <label for="homeInput" class="addr-label">Find nearest address:</label>
  <input id="homeInput" type="text" placeholder="Home Address" autocomplete="off"/>

  <button id="searchBtn">Search</button>
</div>

<div id="nearest"></div>

<div class="table-wrapper"><table id="tabla" class="display"></table></div>
<div id="cards" class="cards"></div>
<div id="error" hidden></div>

<!-- Maps JS w/ Places -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4LU0O02a7lCRtZeyGbigQQcJ4EuSKa7A&libraries=places&callback=initApp"></script>

<script src="./xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.2/js/dataTables.min.js"></script>

<script>
const geoCache=new Map();
let geocoder,distSvc;

/* map Spanish days to JS weekday index */
const dayMap={'DOMINGO':0,'SUNDAY':0,'LUNES':1,'MONDAY':1,'MARTES':2,'TUESDAY':2,
  'MIERCOLES':3,'MIÉRCOLES':3,'WEDNESDAY':3,'JUEVES':4,'THURSDAY':4,'VIERNES':5,'FRIDAY':5,
  'SABADO':6,'SÁBADO':6,'SATURDAY':6};

function nextOccurrence(dia,hora){
  const [h,m]=hora.split(':').map(Number);
  const target=dayMap[dia.toUpperCase()]??0;
  const now=new Date();
  let d=new Date(now);d.setHours(h,m,0,0);
  let diff=(target-d.getDay()+7)%7;
  if(diff===0&&d<now)diff=7;
  d.setDate(d.getDate()+diff);
  return d;
}

function geocode(addr){
  if(geoCache.has(addr))return geoCache.get(addr);
  return new Promise(r=>geocoder.geocode({address:addr},(res,s)=>{
    const loc=s==='OK'?{lat:res[0].geometry.location.lat(),lng:res[0].geometry.location.lng()}:null;
    geoCache.set(addr,loc);r(loc);
  }));
}

function driveTime(orig,dest,departure){
  return new Promise(res=>{
    distSvc.getDistanceMatrix({
      origins:[new google.maps.LatLng(orig.lat,orig.lng)],
      destinations:[new google.maps.LatLng(dest.lat,dest.lng)],
      travelMode:'DRIVING',
      drivingOptions:{departureTime:departure,trafficModel:'best_guess'}
    },(dm,s)=>res(s==='OK'&&dm.rows[0].elements[0].status==='OK'
      ? dm.rows[0].elements[0].duration_in_traffic.value
      : null));
  });
}

async function initApp(){
  geocoder=new google.maps.Geocoder();
  distSvc =new google.maps.DistanceMatrixService();

  const wb=XLSX.read(await fetch('celulas.xlsx').then(r=>r.arrayBuffer()),{type:'array'});
  const sh=wb.Sheets['Consolidado']??wb.Sheets[wb.SheetNames[0]];
  const arr=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
  const header=arr[0].map(h=>String(h).trim());
  const rows=arr.slice(1).filter(r=>r.some(x=>x!=='')).map(r=>{const o={};header.forEach((h,i)=>o[h]=r[i]);return o});
  const zonaIdx=header.findIndex(h=>h.toUpperCase()==='ZONA'),numIdx=header.findIndex(h=>h.trim()==='#');

  const sel=document.getElementById('zonaSelect');
  [...new Set(rows.map(r=>r['ZONA']).filter(Boolean))].sort().forEach(z=>sel.add(new Option(z,z)));

  const table=new DataTable('#tabla',{data:rows,columns:header.map(h=>({title:h,data:h})),
    order:[[numIdx,'asc'],[zonaIdx,'asc']],pageLength:10,scrollY:'100%',scrollCollapse:true,autoWidth:false});
  table.columns.adjust();

  const cards=document.getElementById('cards');
  const render=s=>cards.innerHTML=s.map(o=>`
    <div class="card"><h2>#${o['#']} – ${o['ZONA']}</h2>
      <p><strong>Dirección:</strong> ${o['DIRECCION']}</p>
      <p><strong>Día / Hora:</strong> ${o['DIA']} ${o['HORA']}</p>
      <p><strong>Maestro:</strong> ${o['MAESTRO']}</p></div>`).join('');
  render(rows);

  sel.addEventListener('change',()=>{const v=sel.value,f=v?rows.filter(r=>r['ZONA']===v):rows;
    table.clear().rows.add(f).draw();table.columns.adjust();render(f);document.getElementById('nearest').textContent='';});

  const input=document.getElementById('homeInput'),btn=document.getElementById('searchBtn'),out=document.getElementById('nearest');
  let home=null;
  new google.maps.places.Autocomplete(input,{types:['geocode']})
    .addListener('place_changed',function(){
      const plc=this.getPlace();home=plc.geometry?{lat:plc.geometry.location.lat(),lng:plc.geometry.location.lng()}:null;
    });

  btn.addEventListener('click',async()=>{
    const raw=input.value.trim();if(!raw)return;
    btn.disabled=true;out.textContent='Buscando...';
    try{
      if(!home)home=await geocode(raw);if(!home)throw new Error('No se pudo geocodificar');
      let best=null,minSec=1e12;
      for(const r of rows){
        let a=r['DIRECCION']||'';const idx=a.indexOf('-');if(idx!==-1)a=a.slice(idx+1).trim();
        const dest=await geocode(a);if(!dest)continue;
        const sec=await driveTime(home,dest,new Date());if(sec==null)continue;
        if(sec<minSec){minSec=sec;best=r;}
      }
      if(!best)throw new Error('No se encontró destino');
      /* predicted travel at scheduled time */
      const sched=nextOccurrence(best['DIA'],best['HORA']);
      let destAddr=best['DIRECCION'];const cut=destAddr.indexOf('-');if(cut!==-1)destAddr=destAddr.slice(cut+1).trim();
      const destPos=await geocode(destAddr);
      const secSched=await driveTime(home,destPos,sched);
      const mins=Math.round(secSched/60);
      const schedStr=sched.toLocaleString('es-ES',{weekday:'long',hour:'numeric',minute:'2-digit'});

      out.textContent=`≈ ${mins} min de manejo para llegar el ${schedStr}`;

      table.clear().rows.add([best]).draw();table.columns.adjust();render([best]);
    }catch(e){out.textContent='Error: '+e.message;}
    btn.disabled=false;
  });
}
</script>
</body>
</html>
