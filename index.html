<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Células de Crecimiento | Zona</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
<style>
/* -------- estilos: idénticos a los que ya usas -------- */
body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fafafa}

header .banner{display:block;width:100%;height:auto;max-height:25vh;object-fit:contain;margin:0}

.controls{margin:1rem 2rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
#zonaSelect,#homeInput{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px}
#homeInput{min-width:260px;flex:1 1 260px}
#homeInput::placeholder{color:#999}
#searchBtn{padding:.35rem .9rem;font-size:1rem;border:1px solid #2d57a3;background:#2d57a3;color:#fff;border-radius:4px;cursor:pointer}
#searchBtn:disabled{opacity:.5;cursor:not-allowed}

.table-wrapper{height:65vh;overflow:auto;padding:0 2rem 1.5rem}
table.dataTable{border:2px solid #13284b;border-collapse:collapse;width:100%;table-layout:fixed}
table.dataTable thead th{background:#2d57a3;color:#fff;border:1px solid #13284b;font-weight:700;text-align:center}
table.dataTable td{border:1px solid #ccc;padding:6px 4px;word-wrap:break-word}
table.dataTable tbody td:nth-child(1){background:#eee;font-weight:700;text-align:center}
table.dataTable tbody tr:nth-child(even) td{background:#f8f8f8}

.cards{display:none;padding:0 1rem 2rem;overflow:auto;height:65vh}
.card{border:1px solid #ccc;border-radius:6px;margin-bottom:1rem;padding:1rem;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.card p{margin:.25rem 0;font-size:.95rem}

@media(max-width:900px){
  .table-wrapper{display:none}
  .cards{display:block}
  .controls{margin:1rem}
}

#nearest{margin:.5rem 2rem 0;font-weight:600}
#error{color:#c00;margin:1rem 2rem 0;font-weight:700}
</style>
</head>
<body>
<header>
  <img src="./header.svg" class="banner" alt="La Cosecha – Células">
</header>

<div class="controls">
  <label for="zonaSelect"><strong>Zona:</strong></label>
  <select id="zonaSelect"><option value="">— Todas —</option></select>

  <label for="homeInput" class="addr-label">Buscar dirección más cercana:</label>
  <input id="homeInput" type="text" placeholder="Dirección de casa"/>
  <button id="searchBtn">Buscar</button>
</div>

<div id="nearest"></div>

<div class="table-wrapper"><table id="tabla" class="display"></table></div>
<div id="cards"  class="cards"></div>
<div id="error"  hidden></div>

<script src="./xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4LU0O02a7lCRtZeyGbigQQcJ4EuSKa7A&libraries=places&callback=gmapsReady">
</script>

<script>
/* ---------- constantes ---------- */
const HUB_ADDR = '600 Greenwich St, Hempstead, NY 11550';

/* ---------- estado ---------- */
let headES=[], rows=[], table, cardsDiv,
    geocoder, distSvc, homePos=null; // homePos will store {lat, lng} of user's address
const geoCache=new Map();

/* ---------- Google Maps listo ---------- */
async function gmapsReady(){
  geocoder=new google.maps.Geocoder();
  distSvc =new google.maps.DistanceMatrixService();
  await loadSheet();                      // lee Excel y construye UI

  const ac=new google.maps.places.Autocomplete(
    document.getElementById('homeInput'),{types:['geocode']});
  ac.addListener('place_changed',()=>{
    const p=ac.getPlace();
    homePos = p.geometry ? {lat:p.geometry.location.lat(),
                            lng:p.geometry.location.lng()} : null;
    if (!homePos) {
        // Optionally clear previous results if place is cleared or invalid
        document.getElementById('nearest').textContent = '';
        // Potentially reset ETA_FROM_HOME in rows if needed, or rely on filterAndDisplayCells
    }
  });
  document.getElementById('searchBtn').addEventListener('click',runSearch);
}

/* ---------- lee Excel, filtra y reemplaza dirección por ETA ---------- */
async function loadSheet(){
  try{
    const wb=XLSX.read(await fetch('celulas.xlsx').then(r=>r.arrayBuffer()),{type:'array'});
    const sh=wb.Sheets['Consolidado']??wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
    headES  =arr[0].map(h=>String(h).trim());

    rows = arr.slice(1)
             .filter(r=>r.some(x=>x!==''))
             .map(r=>{
               const o={}; headES.forEach((h,i)=>o[h]=r[i]); return o;
             })
             .filter(o=>{
               const l=String(o['IDIOMA']).toLowerCase();
               return l==='español'||l==='bilingüe';
             });

    /* ▸ calcular ETA celda → HUB y sustituir dirección */
    await Promise.all(rows.map(async o=>{
      o['DIRECCION_RAW'] = o['DIRECCION']; // guarda original
      const etaHub = await driveMinutes(o['DIRECCION_RAW'], HUB_ADDR);
      o['ETA_FROM_HUB'] = etaHub; // Store numeric ETA or null
      o['DIRECCION'] = etaHub != null ? `≈ ${etaHub} min` : '—'; // Default display
      o['ETA_FROM_HOME'] = null; // Initialize ETA from home
    }));

    buildUI();
  }catch(e){ $('#error').show().text(e); }
}

/* ---------- construye DataTable y tarjetas ---------- */
function buildUI(){
  [...new Set(rows.map(r=>r['ZONA']).filter(Boolean))].sort()
    .forEach(z=>$('#zonaSelect').append(`<option value="${z}">${z}</option>`));

  const numIdx=headES.indexOf('#'), zonaIdx=headES.indexOf('ZONA');

  table=$('#tabla').DataTable({
    columns:headES.map(h=>({title:h,data:h})),
    order:[[numIdx,'asc'],[zonaIdx,'asc']],
    pageLength:10
  });
  cardsDiv=document.getElementById('cards');
  
  filterAndDisplayCells(); // Initial population of table and cards

  $('#zonaSelect').on('change',function(){
    // Do not clear #nearest here, user might want to see nearest info while changing zone
    // $('#nearest').text(''); 
    filterAndDisplayCells(); 
  });
}

/* ---------- Prepara datos y actualiza DataTable y Tarjetas ---------- */
function filterAndDisplayCells() {
  const selectedZone = $('#zonaSelect').val();
  let currentFilteredRows = selectedZone ? rows.filter(r => r['ZONA'] === selectedZone) : [...rows]; 

  const displayList = currentFilteredRows.map(cell => {
    const cellForDisplay = {...cell}; // Create a copy for modification

    // Check if homePos is set (meaning a search occurred/place selected) AND ETA_FROM_HOME is calculated
    if (homePos && typeof cell.ETA_FROM_HOME === 'number') { 
      cellForDisplay['DIRECCION'] = `≈ ${cell.ETA_FROM_HOME} min`;
    } else {
      // Fallback to HUB ETA text (already set in cell.DIRECCION or derive from ETA_FROM_HUB)
      cellForDisplay['DIRECCION'] = cell.ETA_FROM_HUB != null ? `≈ ${cell.ETA_FROM_HUB} min` : '—';
    }
    return cellForDisplay;
  });

  if (table) { 
    table.clear().rows.add(displayList).draw();
  }
  if (cardsDiv) { 
    renderCards(displayList);
  }
}


/* ---------- render Cards (todas las columnas) ---------- */
function renderCards(list){
  cardsDiv.innerHTML=list.map(o=>{
    // Ensure 'DIRECCION' shown in cards is the potentially modified one
    const lines=headES.map(h=>`<p><strong>${h}:</strong> ${o[h]}</p>`).join('');
    return `<div class="card">${lines}</div>`;
  }).join('');
}

/* ---------- utilidades geocodificación / ETA ---------- */
async function getCoords(locationInput) {
  if (typeof locationInput === 'string') {
    if(geoCache.has(locationInput)) return geoCache.get(locationInput);
    return new Promise(r=>geocoder.geocode({address:locationInput},(re,st)=>{
      const loc=st==='OK'?{lat:re[0].geometry.location.lat(),lng:re[0].geometry.location.lng()}:null;
      geoCache.set(locationInput,loc); r(loc);
    }));
  } else if (locationInput && typeof locationInput.lat === 'number' && typeof locationInput.lng === 'number') {
    return locationInput; // Already {lat, lng}
  }
  console.warn("Invalid location input for getCoords:", locationInput);
  return null; 
}

const gc = addr => getCoords(addr); // Keep gc for simplicity if preferred, though getCoords is more descriptive

async function driveMinutes(originInput, destinationInput){
  const oCoords = await getCoords(originInput);
  const dCoords = await getCoords(destinationInput);
  if(!oCoords || !dCoords) return null;

  return new Promise(r=>distSvc.getDistanceMatrix({
    origins:[new google.maps.LatLng(oCoords.lat, oCoords.lng)],
    destinations:[new google.maps.LatLng(dCoords.lat, dCoords.lng)],
    travelMode:'DRIVING',
    drivingOptions:{departureTime:new Date()} // Using departureTime for traffic estimation
  },(m,st)=>{
    const el=m?.rows[0].elements[0];
    r(st==='OK'&&el.status==='OK'
        ? Math.round((el.duration_in_traffic||el.duration).value/60) // Prioritize duration_in_traffic
        : null);
  }));
}

/* ---------- búsqueda del usuario ---------- */
async function runSearch(){
  const rawHomeAddress = document.getElementById('homeInput').value.trim();
  const out = document.getElementById('nearest');
  const btn = document.getElementById('searchBtn');
  
  if (!rawHomeAddress) {
    out.textContent = 'Por favor, ingrese una dirección de casa.';
    return;
  }
  if (!homePos && rawHomeAddress) { // If homePos not set by autocomplete, try to geocode now
      const loc = await getCoords(rawHomeAddress);
      if (!loc) {
          out.textContent = 'Error: No se pudo geocodificar la dirección de casa ingresada.';
          return;
      }
      homePos = loc;
  }
  if (!homePos) { // Still no homePos
    out.textContent = 'Error: Dirección de casa no válida o no seleccionada.';
    return;
  }

  btn.disabled = true; 
  out.textContent = 'Buscando células cercanas…';

  try {
    // Calculate ETA from home for ALL cells and store it in the main 'rows' array
    const promises = rows.map(async (cell) => {
      const eta = await driveMinutes(homePos, cell['DIRECCION_RAW']);
      cell.ETA_FROM_HOME = eta; // Update the main rows array
      return cell; // Return cell for further processing if needed, not strictly necessary here
    });
    await Promise.all(promises);

    // Create a temporary list with ETAs for sorting, ensuring ETA_FROM_HOME is considered
    let cellsWithEta = rows.map(cell => ({...cell})); // Work with copies for sorting

    // Sort by ETA_FROM_HOME, nulls (errors in calculation) last
    cellsWithEta.sort((a, b) => {
      if (a.ETA_FROM_HOME === null && b.ETA_FROM_HOME === null) return 0;
      if (a.ETA_FROM_HOME === null) return 1;
      if (b.ETA_FROM_HOME === null) return -1;
      return a.ETA_FROM_HOME - b.ETA_FROM_HOME;
    });

    const nearestThree = cellsWithEta.filter(c => c.ETA_FROM_HOME !== null).slice(0, 3);

    if (nearestThree.length > 0) {
      const nearestCell = nearestThree[0];
      out.textContent = `La célula más cercana (#${nearestCell['#']}) está a ≈ ${nearestCell.ETA_FROM_HOME} min. ` +
                        `Maestro/a: ${nearestCell['NOMBRE DEL MAESTRO/A']}, ` +
                        `Tel: ${nearestCell['NUMERO DE TELEFONO']}.`;
      
      // Prepare these three cells for display with their 'DIRECCION' showing ETA from home
      const displayDataNearestThree = nearestThree.map(cell => {
        const displayCell = {...cell};
        displayCell['DIRECCION'] = `≈ ${cell.ETA_FROM_HOME} min`;
        return displayCell;
      });

      table.clear().rows.add(displayDataNearestThree).draw();
      renderCards(displayDataNearestThree);
      // Note: The zone filter is NOT changed here. The user's next interaction with it
      // will use filterAndDisplayCells, which will apply home ETAs if available.
    } else {
      out.textContent = 'No se encontraron células cercanas o no se pudo calcular el tiempo de viaje.';
    }

  } catch(e) {
    out.textContent = 'Error durante la búsqueda: ' + e.message;
    console.error("Error in runSearch:", e);
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>
