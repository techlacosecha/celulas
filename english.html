<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Growth Cells | Zone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#2d57a3">
    <style>
        /* -------- Estilos CSS (Restored from index.html) -------- */
        body {
            font-family: system-ui, Arial, sans-serif;
            margin: 0;
            background: #fafafa
        }

        header .banner {
            display: block;
            width: 100%;
            height: auto;
            max-height: 25vh;
            object-fit: contain;
            margin: 0
        }

        .controls {
            margin: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: .75rem;
            align-items: center
        }

        #zonaSelect,
        #homeInput {
            padding: .35rem .6rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px
        }

        #homeInput {
            min-width: 260px;
            flex: 1 1 260px
        }

        #homeInput::placeholder {
            color: #999
        }

        #searchBtn {
            padding: .35rem .9rem;
            font-size: 1rem;
            border: 1px solid #2d57a3;
            background: #2d57a3;
            color: #fff;
            border-radius: 4px;
            cursor: pointer
        }

        #searchBtn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        #searchBtn:hover {
            background-color: #214e96;
        }

        .table-wrapper {
            height: 65vh;
            overflow: auto;
            padding: 0 2rem 1.5rem
        }

        table.dataTable {
            border: 2px solid #13284b;
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed
        }

        table.dataTable thead th {
            background: #2d57a3;
            color: #fff;
            border: 1px solid #13284b;
            font-weight: 700;
            text-align: center
        }

        table.dataTable td {
            border: 1px solid #ccc;
            padding: 6px 4px;
            word-wrap: break-word
        }

        table.dataTable tbody td:nth-child(1) {
            background: #eee;
            font-weight: 700;
            text-align: center
        }

        table.dataTable tbody tr:nth-child(even) td {
            background: #f8f8f8
        }

        .cards {
            display: none;
            padding: 0 1rem 2rem;
            overflow: auto;
            height: 65vh
        }

        .card {
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .05)
        }

        .card p {
            margin: .25rem 0;
            font-size: .95rem
        }

        @media(max-width:900px) {
            .table-wrapper {
                display: none
            }

            .cards {
                display: block
            }

            .controls {
                margin: 1rem
            }
        }

        #nearest {
            margin: .5rem 2rem 0;
            font-weight: 600;
            color: #28a745;
        }

        #error {
            color: #c00;
            margin: 1rem 2rem 0;
            font-weight: 700
        }

        #installBtn {
            padding: .35rem .9rem;
            font-size: 1rem;
            background: #28a745;
            border: 1px solid #28a745;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            margin-left: auto;
            display: inline-block;
            /* Always visible unless redundant */
        }

        #installBtn:hover {
            background-color: #218838;
        }

        @media (max-width: 900px) {
            #installBtn {
                margin-left: 0;
                width: 100%;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <header>
        <img src="english_header.svg" class="banner" alt="Growth Cells Banner">
    </header>

    <div class="controls">
        <label for="zonaSelect"><strong>Zone:</strong></label>
        <select id="zonaSelect">
            <option value="">— All —</option>
        </select>
        <label for="homeInput" class="addr-label">Find nearest group:</label>
        <input id="homeInput" type="text" placeholder="Enter your address..." />
        <button id="searchBtn">Search</button>
        <button id="installBtn">Download App</button>
    </div>

    <div id="nearest"></div>

    <div class="table-wrapper">
        <table id="tabla" class="display"></table>
    </div>
    <div id="cards" class="cards"></div>
    <div id="error" hidden></div>

    <!-- SMART INSTALL GUIDE OVERLAY -->
    <div id="installGuide" class="install-guide" hidden>
        <div class="guide-content">
            <button class="close-guide" id="closeGuide">&times;</button>
            <div id="iosGuide" hidden>
                <h3>Install on iPhone</h3>
                <p>1. Tap the <strong>Share</strong> button <span class="icon-share"></span> below.</p>
                <p>2. Scroll down and select <br><strong>"Add to Home Screen"</strong> <span class="icon-plus">+</span>.
                </p>
                <div class="arrow-down">⬇</div>
            </div>
            <div id="androidGuide" hidden>
                <h3>Install App</h3>
                <p>Tap the menu button (⋮) and select <strong>"Install App"</strong> or <strong>"Add to Home
                        Screen"</strong>.</p>
            </div>
        </div>
    </div>

    <style>
        /* OVERLAY STYLES */
        .install-guide {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            /* Align to bottom for iOS */
            padding-bottom: 2rem;
            color: #fff;
            text-align: center;
        }

        .guide-content {
            background: #1e1e1e;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            position: relative;
            margin-bottom: 50px;
            /* Space for the arrow */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .close-guide {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .arrow-down {
            font-size: 3rem;
            margin-top: 1rem;
            animation: bounce 2s infinite;
            color: #28a745;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .icon-share {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>') no-repeat center center;
            background-size: contain;
            vertical-align: middle;
        }

        .icon-plus {
            font-weight: bold;
            font-size: 1.2rem;
            color: #fff;
            background: #ccc;
            color: #000;
            border-radius: 4px;
            padding: 0 4px;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        /* ==========================================================================
           JavaScript Logic - English V10 (Smart Install Guide Overlay)
           ========================================================================== */

        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        const guideOverlay = document.getElementById('installGuide');
        const iosGuide = document.getElementById('iosGuide');
        const androidGuide = document.getElementById('androidGuide');
        const closeGuide = document.getElementById('closeGuide');

        function showGuide(isIOS) {
            guideOverlay.hidden = false;
            guideOverlay.style.display = 'flex'; // Ensure flex layout
            if (isIOS) {
                iosGuide.hidden = false;
                androidGuide.hidden = true;
            } else {
                iosGuide.hidden = true;
                androidGuide.hidden = false;
                // For non-iOS manual fallback, center it
                guideOverlay.style.justifyContent = 'center';
                guideOverlay.style.paddingBottom = '0';
            }
        }

        closeGuide.addEventListener('click', () => {
            guideOverlay.hidden = true;
            guideOverlay.style.display = 'none';
        });

        // 1. Check if already in Standalone (App) Mode -> Hide Button
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            installBtn.style.display = 'none';
        }

        // 2. Service Worker Reg
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }

        // 3. Listen for Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('beforeinstallprompt fired');
        });

        // 4. Handle Click
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Happy Path: Automatic Prompt
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
            } else {
                // Fallback Path: Show Guide
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                showGuide(isIOS);
            }
        });

        const HUB_ADDR = '600 Greenwich St, Hempstead, NY 11550';
        let headES = [];
        let geocoder;
        let distSvc;
        let homePos = null;
        let rows = [];
        let table;

        // --- TRANSLATION MAPS ---
        const headerTranslationMap = {
            '#': '#', 'ZONA': 'Zone', 'RED': 'Network', 'DISTRITO': 'District', 'CELULA': 'Group',
            'SUPERVISOR': 'Supervisor', 'LIDER': 'Leader', 'ANFITRION': 'Host', 'DIRECCION': 'Address/ETA',
            'DIA': 'Day', 'HORA': 'Time', 'IDIOMA': 'Language', 'TIPO DE CELULA': 'Group Type',
            'STATUS': 'Status', 'NOMBRE DEL MAESTRO/A': 'Teacher/Host', 'MAESTRO': 'Teacher',
            'MAESTRA': 'Teacher', 'DIRECTOR': 'Director', 'NUMERO DE TELEFONO': 'Phone Number',
            'TELEFONO': 'Phone', 'LINK': 'Link', 'ASISTENTES': 'Attendees', 'ASISTENTE': 'Assistant', 'NIÑOS': 'Children',
            'FECHA DE APERTURA': 'Opening Date', 'ASISTENCIA LIDERES': 'Leaders Attended', 'OBSERVACIONES': 'Observations'
        };

        const dayTranslationMap = {
            'lunes': 'Monday',
            'martes': 'Tuesday',
            'miercoles': 'Wednesday', 'miércoles': 'Wednesday',
            'jueves': 'Thursday',
            'viernes': 'Friday',
            'sabado': 'Saturday', 'sábado': 'Saturday',
            'domingo': 'Sunday'
        };

        function translateValue(key, value) {
            if (!value || typeof value !== 'string') return value;
            const lowerVal = value.trim().toLowerCase();

            if (key === 'DIA' && dayTranslationMap[lowerVal]) {
                return dayTranslationMap[lowerVal];
            }

            if (key === 'TIPO DE CELULA') {
                if (lowerVal === 'presencial') return 'In-Person';
                if (lowerVal === 'hibrido' || lowerVal === 'híbrido') return 'Hybrid';
                if (lowerVal === 'virtual' || lowerVal === 'zoom') return 'Virtual (Zoom)';
            }

            if (key === 'STATUS') {
                if (lowerVal === 'activo' || lowerVal === 'activa') return 'Active';
                if (lowerVal === 'inactivo' || lowerVal === 'inactiva') return 'Inactive';
            }

            return value;
        }

        function formatHeaderTitle(str) {
            if (!str || typeof str !== 'string') return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        async function gmapsReady() {
            geocoder = new google.maps.Geocoder();
            distSvc = new google.maps.DistanceMatrixService();

            const autocompleteInput = document.getElementById('homeInput');
            const ac = new google.maps.places.Autocomplete(autocompleteInput, { types: ['geocode'] });

            ac.addListener('place_changed', () => {
                const place = ac.getPlace();
                const wasHomePosSet = !!homePos;
                homePos = place.geometry ? { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() } : null;

                if (!homePos && wasHomePosSet) {
                    document.getElementById('nearest').textContent = '';
                    updateDireccionHeader('Drive from Church');
                    filterAndDisplayCells();
                }
                if (homePos) {
                    updateDireccionHeader('Drive from Home');
                    filterAndDisplayCells();
                }
            });

            autocompleteInput.addEventListener('input', () => {
                if (autocompleteInput.value === '' && homePos) {
                    homePos = null;
                    document.getElementById('nearest').textContent = '';
                    updateDireccionHeader('Drive from Church');
                    filterAndDisplayCells();
                }
            });

            if (rows.length > 0) {
                calcETAsFromHub();
            }
        }

        function updateDireccionHeader(title) {
            const direccionColumnIndex = headES.indexOf('DIRECCION');
            if (direccionColumnIndex !== -1 && table) {
                const column = table.column(direccionColumnIndex);
                $(column.header()).html(formatHeaderTitle(title));
            }
        }

        function loadSheet() {
            fetch('celulas.xlsx')
                .then(r => r.arrayBuffer())
                .then(async data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetVar = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheetVar, { header: 1 });
                    if (!json || json.length === 0) return;
                    headES = json[0];
                    const dataRows = json.slice(1);

                    rows = dataRows.map(r => {
                        let obj = {};
                        headES.forEach((k, i) => {
                            obj[k] = translateValue(k, r[i]);
                        });

                        let lang = (obj['IDIOMA'] || '').trim().toLowerCase();
                        if (lang === 'bilingue' || lang === 'bilingüe' || lang === 'bilingual') {
                            obj['IDIOMA'] = 'Bilingual';
                            lang = 'bilingual';
                        }
                        if (lang === 'english' || lang === 'ingles' || lang === 'inglés') {
                            obj['IDIOMA'] = 'English';
                            lang = 'english';
                        }

                        if (lang !== 'english' && lang !== 'bilingual') {
                            return null;
                        }

                        obj.DIRECCION_FROM_EXCEL = obj.DIRECCION;
                        if (obj.ZONA && obj.ZONA.toLowerCase() === 'la cosecha') {
                            obj.EFFECTIVE_ROUTING_ADDRESS = HUB_ADDR;
                        } else {
                            obj.EFFECTIVE_ROUTING_ADDRESS = obj.DIRECCION;
                        }
                        obj.ETA_FROM_HUB = null;
                        obj.ETA_FROM_HOME = null;
                        return obj;
                    }).filter(r => r !== null);

                    buildUI();
                    filterAndDisplayCells();

                    if (distSvc) {
                        calcETAsFromHub();
                    }
                })
                .catch(err => {
                    document.getElementById('error').textContent = "Error loading data: " + err.message;
                    document.getElementById('error').hidden = false;
                });
        }
        loadSheet();

        async function calcETAsFromHub() {
            if (!distSvc || !rows.length) return;
            const targets = rows.filter(r => r.EFFECTIVE_ROUTING_ADDRESS && !r.EFFECTIVE_ROUTING_ADDRESS.toLowerCase().includes('zoom') && r.ETA_FROM_HUB === null);
            if (targets.length === 0) return;

            const chunkSize = 10;
            for (let i = 0; i < targets.length; i += chunkSize) {
                const chunk = targets.slice(i, i + chunkSize);
                const destConnectors = chunk.map(r => r.EFFECTIVE_ROUTING_ADDRESS);

                try {
                    await new Promise(resolve => {
                        distSvc.getDistanceMatrix({
                            origins: [HUB_ADDR],
                            destinations: destConnectors,
                            travelMode: 'DRIVING',
                        }, (response, status) => {
                            if (status === 'OK') {
                                const results = response.rows[0].elements;
                                chunk.forEach((row, idx) => {
                                    const element = results[idx];
                                    if (element.status === 'OK') {
                                        row.ETA_FROM_HUB = Math.round(element.duration.value / 60);
                                    }
                                });
                                filterAndDisplayCells();
                            }
                            resolve();
                        });
                    });
                } catch (e) { console.error(e); }
                await new Promise(r => setTimeout(r, 500));
            }
        }

        function buildUI() {
            const zoneSet = new Set();
            rows.forEach(r => { if (r.ZONA) zoneSet.add(r.ZONA); });
            const sel = document.getElementById('zonaSelect');
            if (sel) {
                sel.innerHTML = '<option value="">— All —</option>';
                Array.from(zoneSet).sort().forEach(z => {
                    const op = document.createElement('option');
                    op.value = z;
                    op.textContent = z;
                    sel.appendChild(op);
                });
                sel.addEventListener('change', filterAndDisplayCells);
            }

            if ($.fn.DataTable.isDataTable('#tabla')) $('#tabla').DataTable().destroy();

            const columns = headES.map(key => {
                let title = headerTranslationMap[key] || formatHeaderTitle(key);
                if (key === 'DIRECCION') title = 'Drive from Church';
                return {
                    title: title,
                    data: key,
                    visible: (key !== 'LINK' && key !== 'STATUS'),
                    defaultContent: ""
                };
            });

            table = $('#tabla').DataTable({
                data: [],
                columns: columns,
                pageLength: 10,
                ordering: true,
                searching: true,
                info: true
            });
        }

        function filterAndDisplayCells() {
            const zoneVal = document.getElementById('zonaSelect').value;

            let currentFilteredRows = rows.filter(r => {
                if (zoneVal && r.ZONA !== zoneVal) return false;
                return true;
            });

            if (homePos) {
                currentFilteredRows.sort((a, b) => {
                    if (a.ETA_FROM_HOME == null) return 1;
                    if (b.ETA_FROM_HOME == null) return -1;
                    return a.ETA_FROM_HOME - b.ETA_FROM_HOME;
                });
            }

            const displayList = currentFilteredRows.map(cell => {
                let cellForDisplay = { ...cell };
                const lowerAddr = (cell.DIRECCION_FROM_EXCEL || cell.DIRECCION || '').toLowerCase();
                const lowerZone = (cell.ZONA || '').toLowerCase();

                if (lowerAddr.includes('zoom') || lowerZone.includes('zoom')) {
                    cellForDisplay['DIRECCION'] = 'Online via Zoom';
                } else if (homePos && typeof cell.ETA_FROM_HOME === 'number') {
                    cellForDisplay['DIRECCION'] = `≈ ${cell.ETA_FROM_HOME} min`;
                } else {
                    if (lowerZone === 'la cosecha') {
                        cellForDisplay['DIRECCION'] = 'Church main hall';
                    } else {
                        cellForDisplay['DIRECCION'] = cell.ETA_FROM_HUB != null ? `≈ ${cell.ETA_FROM_HUB} min from Church` : (cell.DIRECCION || '—');
                    }
                }
                return cellForDisplay;
            });

            if (table) {
                table.clear();
                table.rows.add(displayList);
                table.draw();
            }

            const cardsDiv = document.getElementById('cards');
            if (cardsDiv) {
                renderCards(displayList);
            }
        }

        function renderCards(list) {
            const cardsDiv = document.getElementById('cards');
            if (!cardsDiv) return;

            cardsDiv.innerHTML = list.map(cell => {
                const lines = headES.map(key => {
                    if (key === 'LINK' || key === 'STATUS') return '';
                    let label = headerTranslationMap[key] || formatHeaderTitle(key);
                    if (key === 'DIRECCION') {
                        if (homePos) label = 'Drive from Home';
                        else label = 'Drive from Church';
                    }
                    const val = cell[key];
                    return `<p><strong>${label}:</strong> ${val}</p>`;
                }).join('');
                return `<div class="card">${lines}</div>`;
            }).join('');
        }

        async function runSearch() {
            if (!homePos) return;
            const searchBtn = document.getElementById('searchBtn');
            const nearestDiv = document.getElementById('nearest');
            searchBtn.disabled = true;
            nearestDiv.textContent = 'Calculating routes...';

            const targets = rows.filter(r => r.EFFECTIVE_ROUTING_ADDRESS && !r.EFFECTIVE_ROUTING_ADDRESS.toLowerCase().includes('zoom'));
            const chunkSize = 10;

            for (let i = 0; i < targets.length; i += chunkSize) {
                const chunk = targets.slice(i, i + chunkSize);
                const destConnectors = chunk.map(r => r.EFFECTIVE_ROUTING_ADDRESS);
                try {
                    await new Promise(resolve => {
                        distSvc.getDistanceMatrix({
                            origins: [homePos],
                            destinations: destConnectors,
                            travelMode: 'DRIVING',
                            drivingOptions: { departureTime: new Date() }
                        }, (response, status) => {
                            if (status === 'OK') {
                                const results = response.rows[0].elements;
                                chunk.forEach((row, idx) => {
                                    const element = results[idx];
                                    if (element.status === 'OK') {
                                        row.ETA_FROM_HUB = Math.round(element.duration_in_traffic ? element.duration_in_traffic.value / 60 : element.duration.value / 60);
                                    }
                                });
                            }
                            resolve();
                        });
                    });
                } catch (e) { console.error(e); }
                await new Promise(r => setTimeout(r, 300));
            }

            let nearest = null;
            let minMinutes = Infinity;
            rows.forEach(r => {
                if (typeof r.ETA_FROM_HOME === 'number' && r.ETA_FROM_HOME < minMinutes) {
                    minMinutes = r.ETA_FROM_HOME;
                    nearest = r;
                }
            });

            if (nearest) {
                nearestDiv.textContent = `Nearest: ${nearest.CELULA || '?'} (${minMinutes} min)`;
            } else {
                nearestDiv.textContent = 'No routes found.';
            }

            updateDireccionHeader('Drive from Home');
            filterAndDisplayCells();
            searchBtn.disabled = false;
        }

        document.getElementById('searchBtn').addEventListener('click', runSearch);

    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4LU0O02a7lCRtZeyGbigQQcJ4EuSKa7A&libraries=places&callback=gmapsReady"
        async defer></script>
</body>

</html>