<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Growth Cells | Zone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            margin: 0;
            background: #fafafa
        }

        header .banner {
            display: block;
            width: 100%;
            height: auto;
            max-height: 25vh;
            object-fit: contain;
            margin: 0
        }

        .controls {
            margin: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: .75rem;
            align-items: center
        }

        #zonaSelect,
        #homeInput {
            padding: .35rem .6rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px
        }

        #homeInput {
            flex: 10;
            min-width: 200px
        }

        #searchBtn {
            padding: .35rem 1rem;
            font-size: 1rem;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer
        }

        #searchBtn:hover {
            background-color: #218838
        }

        #nearest {
            font-weight: 700;
            color: #28a745;
            margin: 0 .5rem
        }

        #map {
            height: 400px;
            width: 90%;
            margin: 1rem auto;
            background: #eee;
            border: 1px solid #ddd;
            display: none
        }

        #tabla-container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0 1rem;
            overflow-x: auto
        }

        table.dataTable {
            width: 100%;
            border-collapse: collapse
        }

        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #eee
        }

        .card p {
            margin: .25rem 0
        }

        #cards {
            display: none;
            margin: 1rem 2rem
        }

        @media(max-width:768px) {
            #tabla-container {
                display: none
            }

            #cards {
                display: block
            }

            .controls {
                margin: 1rem
            }
        }
    </style>
</head>

<body>
    <header><img src="english_header.svg" alt="Banner" class="banner"></header>
    <div class="controls"><select id="zonaSelect">
            <option value="">All Zones</option>
        </select><input type="text" id="homeInput" placeholder="Enter your address...">
        <div id="nearest"></div><button id="searchBtn">Search</button>
    </div>
    <div id="map"></div>
    <div id="cards"></div>
    <div id="tabla-container">
        <table id="tabla" class="display" style="width:100%"></table>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        /* ==========================================================================
           JavaScript Logic for Cell Finder Application (English Version - Fixed V4)
           ========================================================================== */

        const HUB_ADDR = '600 Greenwich St, Hempstead, NY 11550';
        let headES = [];
        let geocoder;
        let distSvc;
        let homePos = null;
        const geoCache = new Map();
        let rows = [];
        let table;

        const headerTranslationMap = {
            '#': '#', 'ZONA': 'Zone', 'RED': 'Network', 'DISTRITO': 'District', 'CELULA': 'Group',
            'SUPERVISOR': 'Supervisor', 'LIDER': 'Leader', 'ANFITRION': 'Host', 'DIRECCION': 'Address/ETA',
            'DIA': 'Day', 'HORA': 'Time', 'IDIOMA': 'Language', 'TIPO DE CELULA': 'Group Type',
            'STATUS': 'Status', 'NOMBRE DEL MAESTRO/A': 'Teacher/Host', 'MAESTRO': 'Teacher',
            'MAESTRA': 'Teacher', 'DIRECTOR': 'Director', 'NUMERO DE TELEFONO': 'Phone Number',
            'TELEFONO': 'Phone', 'LINK': 'Link', 'ASISTENTES': 'Attendees', 'NIÑOS': 'Children',
            'FECHA DE APERTURA': 'Opening Date', 'ASISTENCIA LIDERES': 'Leaders Attended', 'OBSERVACIONES': 'Observations'
        };

        function formatHeaderTitle(str) {
            if (!str || typeof str !== 'string') return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        async function gmapsReady() {
            geocoder = new google.maps.Geocoder();
            distSvc = new google.maps.DistanceMatrixService();

            const autocompleteInput = document.getElementById('homeInput');
            const ac = new google.maps.places.Autocomplete(autocompleteInput, { types: ['geocode'] });

            ac.addListener('place_changed', () => {
                const place = ac.getPlace();
                const wasHomePosSet = !!homePos;
                homePos = place.geometry ? { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() } : null;

                if (!homePos && wasHomePosSet) {
                    document.getElementById('nearest').textContent = '';
                    updateDireccionHeader('Drive from Church');
                    filterAndDisplayCells();
                }
                if (homePos) {
                    updateDireccionHeader('Drive from Home');
                    filterAndDisplayCells();
                }
            });

            autocompleteInput.addEventListener('input', () => {
                if (autocompleteInput.value === '' && homePos) {
                    homePos = null;
                    document.getElementById('nearest').textContent = '';
                    updateDireccionHeader('Drive from Church');
                    filterAndDisplayCells();
                }
            });

            // Since map connects, try valid ETAs if rows are ready
            if (rows.length > 0) {
                calcETAsFromHub();
            }
        }

        function updateDireccionHeader(title) {
            const direccionColumnIndex = headES.indexOf('DIRECCION');
            if (direccionColumnIndex !== -1 && table) {
                const column = table.column(direccionColumnIndex);
                $(column.header()).html(formatHeaderTitle(title));
            }
        }

        // Called immediately
        function loadSheet() {
            fetch('celulas.xlsx')
                .then(r => r.arrayBuffer())
                .then(async data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetVar = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheetVar, { header: 1 });
                    if (!json || json.length === 0) return;
                    headES = json[0];
                    const dataRows = json.slice(1);

                    rows = dataRows.map(r => {
                        let obj = {};
                        headES.forEach((k, i) => { obj[k] = r[i]; });
                        obj.DIRECCION_FROM_EXCEL = obj.DIRECCION;
                        if (obj.ZONA && obj.ZONA.toLowerCase() === 'la cosecha') {
                            obj.EFFECTIVE_ROUTING_ADDRESS = HUB_ADDR;
                        } else {
                            obj.EFFECTIVE_ROUTING_ADDRESS = obj.DIRECCION;
                        }
                        obj.ETA_FROM_HUB = null;
                        obj.ETA_FROM_HOME = null;
                        return obj;
                    });

                    // Build logic regardless of Map status
                    buildUI();
                    filterAndDisplayCells();

                    // If Map is already ready, calculate
                    if (distSvc) {
                        calcETAsFromHub();
                    }
                });
        }
        loadSheet();

        async function calcETAsFromHub() {
            if (!distSvc || !rows.length) return;
            const targets = rows.filter(r => r.EFFECTIVE_ROUTING_ADDRESS && !r.EFFECTIVE_ROUTING_ADDRESS.toLowerCase().includes('zoom') && r.ETA_FROM_HUB === null);
            if (targets.length === 0) return;

            const chunkSize = 10;
            for (let i = 0; i < targets.length; i += chunkSize) {
                const chunk = targets.slice(i, i + chunkSize);
                const destConnectors = chunk.map(r => r.EFFECTIVE_ROUTING_ADDRESS);

                try {
                    await new Promise(resolve => {
                        distSvc.getDistanceMatrix({
                            origins: [HUB_ADDR],
                            destinations: destConnectors,
                            travelMode: 'DRIVING',
                        }, (response, status) => {
                            if (status === 'OK') {
                                const results = response.rows[0].elements;
                                chunk.forEach((row, idx) => {
                                    const element = results[idx];
                                    if (element.status === 'OK') {
                                        row.ETA_FROM_HUB = Math.round(element.duration.value / 60);
                                    }
                                });
                                // Refresh UI with new ETAs
                                filterAndDisplayCells();
                            }
                            resolve();
                        });
                    });
                } catch (e) { console.error(e); }
                await new Promise(r => setTimeout(r, 500));
            }
        }

        function buildUI() {
            const zoneSet = new Set();
            rows.forEach(r => { if (r.ZONA) zoneSet.add(r.ZONA); });
            const sel = document.getElementById('zonaSelect');
            if (sel) {
                sel.innerHTML = '<option value="">All Zones</option>';
                Array.from(zoneSet).sort().forEach(z => {
                    const op = document.createElement('option');
                    op.value = z;
                    op.textContent = z;
                    sel.appendChild(op);
                });
                sel.addEventListener('change', filterAndDisplayCells);
            }

            if ($.fn.DataTable.isDataTable('#tabla')) $('#tabla').DataTable().destroy();

            const columns = headES.map(key => {
                let title = headerTranslationMap[key] || formatHeaderTitle(key);
                if (key === 'DIRECCION') title = 'Drive from Church';
                return {
                    title: title,
                    data: key,
                    visible: (key !== 'LINK' && key !== 'STATUS')
                };
            });

            table = $('#tabla').DataTable({
                data: [],
                columns: columns,
                paging: false,
                info: false,
                searching: false
            });
        }

        function filterAndDisplayCells() {
            const zoneVal = document.getElementById('zonaSelect').value.toLowerCase();

            let currentFilteredRows = rows.filter(r => {
                if (zoneVal && (!r.ZONA || r.ZONA.toLowerCase() !== zoneVal)) return false;
                return true;
            });

            // Sorting logic (unchanged)
            if (homePos) {
                currentFilteredRows.sort((a, b) => {
                    if (a.ETA_FROM_HOME == null) return 1;
                    if (b.ETA_FROM_HOME == null) return -1;
                    return a.ETA_FROM_HOME - b.ETA_FROM_HOME;
                });
            } else {
                currentFilteredRows.sort((a, b) => {
                    if (a.ETA_FROM_HUB == null) return 1;
                    if (b.ETA_FROM_HUB == null) return -1;
                    return a.ETA_FROM_HUB - b.ETA_FROM_HUB;
                });
            }

            const displayList = currentFilteredRows.map(cell => {
                let cellForDisplay = { ...cell };

                const lowerAddr = (cell.DIRECCION_FROM_EXCEL || cell.DIRECCION || '').toLowerCase();
                const lowerZone = (cell.ZONA || '').toLowerCase();

                if (lowerAddr.includes('zoom') || lowerZone.includes('zoom')) {
                    cellForDisplay['DIRECCION'] = 'Online via Zoom';
                } else if (homePos && typeof cell.ETA_FROM_HOME === 'number') {
                    cellForDisplay['DIRECCION'] = `≈ ${cell.ETA_FROM_HOME} min`;
                } else {
                    if (lowerZone === 'la cosecha') {
                        cellForDisplay['DIRECCION'] = 'Church main hall (general meeting)';
                    } else {
                        cellForDisplay['DIRECCION'] = cell.ETA_FROM_HUB != null ? `≈ ${cell.ETA_FROM_HUB} min from Church` : (cell.DIRECCION || '—');
                    }
                }
                return cellForDisplay;
            });

            if (table) {
                table.clear();
                table.rows.add(displayList);
                table.draw();
            }

            const cardsDiv = document.getElementById('cards');
            if (cardsDiv) {
                renderCards(displayList);
            }
        }

        function renderCards(list) {
            const cardsDiv = document.getElementById('cards');
            if (!cardsDiv) return;

            cardsDiv.innerHTML = list.map(cell => {
                const lines = headES.map(key => {
                    if (key === 'LINK' || key === 'STATUS') return '';
                    let label = headerTranslationMap[key] || formatHeaderTitle(key);
                    if (key === 'DIRECCION') {
                        if (homePos) label = 'Drive from Home';
                        else label = 'Drive from Church';
                    }
                    const val = cell[key];
                    return `<p><strong>${label}:</strong> ${val}</p>`;
                }).join('');
                return `<div class="card">${lines}</div>`;
            }).join('');
        }

        async function runSearch() {
            if (!homePos) return;
            const searchBtn = document.getElementById('searchBtn');
            const nearestDiv = document.getElementById('nearest');
            searchBtn.disabled = true;
            nearestDiv.textContent = 'Calculating routes...';

            const targets = rows.filter(r => r.EFFECTIVE_ROUTING_ADDRESS && !r.EFFECTIVE_ROUTING_ADDRESS.toLowerCase().includes('zoom'));
            const chunkSize = 10;

            for (let i = 0; i < targets.length; i += chunkSize) {
                const chunk = targets.slice(i, i + chunkSize);
                const destConnectors = chunk.map(r => r.EFFECTIVE_ROUTING_ADDRESS);

                try {
                    await new Promise(resolve => {
                        distSvc.getDistanceMatrix({
                            origins: [homePos],
                            destinations: destConnectors,
                            travelMode: 'DRIVING',
                            drivingOptions: { departureTime: new Date() }
                        }, (response, status) => {
                            if (status === 'OK') {
                                const results = response.rows[0].elements;
                                chunk.forEach((row, idx) => {
                                    const element = results[idx];
                                    if (element.status === 'OK') {
                                        row.ETA_FROM_HOME = Math.round(element.duration_in_traffic ? element.duration_in_traffic.value / 60 : element.duration.value / 60);
                                    }
                                });
                            }
                            resolve();
                        });
                    });
                } catch (e) { console.error(e); }
                await new Promise(r => setTimeout(r, 300));
            }

            let nearest = null;
            let minMinutes = Infinity;
            rows.forEach(r => {
                if (typeof r.ETA_FROM_HOME === 'number' && r.ETA_FROM_HOME < minMinutes) {
                    minMinutes = r.ETA_FROM_HOME;
                    nearest = r;
                }
            });

            if (nearest) {
                nearestDiv.textContent = `Nearest: ${nearest.CELULA || '?'} (${minMinutes} min)`;
            } else {
                nearestDiv.textContent = 'No routes found.';
            }

            updateDireccionHeader('Drive from Home');
            filterAndDisplayCells();
            searchBtn.disabled = false;
        }

        document.getElementById('searchBtn').addEventListener('click', runSearch);

    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4LU0O02a7lCRtZeyGbigQQcJ4EuSKa7A&libraries=places&callback=gmapsReady"
        async defer></script>
</body>

</html>